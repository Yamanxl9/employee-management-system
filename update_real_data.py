#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
Use Real Company and Job Data from Provided Files
"""

import json
import logging
from pymongo import MongoClient
from pymongo.errors import PyMongoError
import os
from datetime import datetime
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('update_real_data.log', encoding='utf-8')
    ]
)
logger = logging.getLogger(__name__)

def get_database_connection():
    """Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        mongodb_uri = os.getenv('MONGODB_URI', 'mongodb://localhost:27017/')
        database_name = os.getenv('MONGODB_DB', 'employees_db')
        
        logger.info(f"ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {database_name}")
        
        client = MongoClient(mongodb_uri)
        client.admin.command('ping')
        
        db = client[database_name]
        logger.info(f"âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {database_name}")
        
        return client, db
        
    except PyMongoError as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        return None, None
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
        return None, None

def load_companies_from_file():
    """ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ"""
    try:
        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹
        import shutil
        source_file = "c:\\Users\\yaman_alne0q1\\OneDrive\\Desktop\\deepseek_json_20250806_6ce2a0.json"
        dest_file = "companies_real.json"
        
        if os.path.exists(source_file):
            shutil.copy2(source_file, dest_file)
            logger.info(f"ğŸ“‚ ØªÙ… Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª: {dest_file}")
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        with open(dest_file, 'r', encoding='utf-8') as file:
            companies_data = json.load(file)
        
        logger.info(f"ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(companies_data)} Ø´Ø±ÙƒØ© Ù…Ù† Ø§Ù„Ù…Ù„Ù")
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        companies = []
        for company in companies_data:
            company_record = {
                'company_code': company.get('Company_code', ''),
                'company_name_eng': company.get('CompanyName_eng', ''),
                'company_name_ara': company.get('CompanyName_ara', ''),
                'created_date': datetime.now()
            }
            companies.append(company_record)
            logger.info(f"   ğŸ“‹ {company_record['company_code']}: {company_record['company_name_ara']}")
        
        return companies
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª: {e}")
        return []

def load_jobs_from_file():
    """ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ"""
    try:
        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹
        import shutil
        source_file = "c:\\Users\\yaman_alne0q1\\OneDrive\\Desktop\\deepseek_json_20250806_b1cd12.json"
        dest_file = "jobs_real.json"
        
        if os.path.exists(source_file):
            shutil.copy2(source_file, dest_file)
            logger.info(f"ğŸ“‚ ØªÙ… Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„ÙˆØ¸Ø§Ø¦Ù: {dest_file}")
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        with open(dest_file, 'r', encoding='utf-8') as file:
            jobs_data = json.load(file)
        
        logger.info(f"ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(jobs_data)} ÙˆØ¸ÙŠÙØ© Ù…Ù† Ø§Ù„Ù…Ù„Ù")
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        jobs = []
        for job in jobs_data:
            job_record = {
                'job_code': job.get('Job_Code', 0),
                'job_eng': job.get('Job_Eng', ''),
                'job_ara': job.get('Job_Ara', ''),
                'created_date': datetime.now()
            }
            jobs.append(job_record)
            logger.info(f"   ğŸ’¼ {job_record['job_code']}: {job_record['job_ara']}")
        
        return jobs
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù: {e}")
        return []

def update_companies(db, companies):
    """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        # Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        db.companies.delete_many({})
        logger.info("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©")
        
        # Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if companies:
            result = db.companies.insert_many(companies)
            logger.info(f"âœ… ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ {len(result.inserted_ids)} Ø´Ø±ÙƒØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©")
            return True
        
        return False
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙƒØ§Øª: {e}")
        return False

def update_jobs(db, jobs):
    """ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        # Ø­Ø°Ù Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        db.jobs.delete_many({})
        logger.info("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©")
        
        # Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if jobs:
            result = db.jobs.insert_many(jobs)
            logger.info(f"âœ… ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ {len(result.inserted_ids)} ÙˆØ¸ÙŠÙØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©")
            return True
        
        return False
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ¸Ø§Ø¦Ù: {e}")
        return False

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    logger.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©...")
    
    # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    client, db = get_database_connection()
    if db is None:
        return False
    
    try:
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
        companies = load_companies_from_file()
        jobs = load_jobs_from_file()
        
        if not companies or not jobs:
            logger.error("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª")
            return False
        
        # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if not update_companies(db, companies):
            logger.error("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙƒØ§Øª")
            return False
        
        if not update_jobs(db, jobs):
            logger.error("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ¸Ø§Ø¦Ù")
            return False
        
        logger.info("ğŸ‰ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!")
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        companies_count = db.companies.count_documents({})
        jobs_count = db.jobs.count_documents({})
        employees_count = db.employees.count_documents({})
        
        logger.info("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:")
        logger.info(f"   - Ø§Ù„Ø´Ø±ÙƒØ§Øª: {companies_count}")
        logger.info(f"   - Ø§Ù„ÙˆØ¸Ø§Ø¦Ù: {jobs_count}")
        logger.info(f"   - Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: {employees_count}")
        
        return True
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {e}")
        return False
    finally:
        # Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„
        if client:
            client.close()
            logger.info("ğŸ” ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")

if __name__ == "__main__":
    success = main()
    if success:
        print("\nâœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!")
        print("ğŸ’¡ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³ØªØ®Ø¯Ù… Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹ ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„ØªÙ‡Ø§")
    else:
        print("\nâŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!")
        exit(1)
